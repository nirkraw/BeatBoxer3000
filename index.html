<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="./dist/main.css" />

    <link href="./public/images/studio.jpg" rel="studio" type="image" />
    <link href="./public/images/redbutton.png" rel="studio" type="image" />


    <link href="./public/audio/kick.wav" rel="kick" type="wav" />
    <link href="./public/audio/hihat.wav" rel="hihat" type="wav" />
    <link href="./public/audio/hey.wav" rel="hey" type="wav" />
    <link href="./public/audio/MRLSHZ_vocal_group_ah_chord_harm_dry_Cm.wav" rel="ah1" type="wav" />
    <link href="./public/audio/MRLSHZ_vocal_group_ah_chord_harm_dry_Fm7.wav" rel="ah2" type="wav" />
    <link href="./public/audio/Reverse_Crash_1.wav" rel="rev-crash" type="wav" />
    <link href="./public/audio/snare.wav" rel="snare" type="wav" />
    <link href="./public/audio/woo.wav" rel="woo" type="wav" />
    <link href="./public/audio/PMBH_Crash_Clash.wav" rel="crash" type="wav" />
    

    <title>Document</title>
  </head>

  <body>
    <script src="./dist/main.js"></script>
    <div class="pad-container">
      <h1 class="beat-boxer-3000">BB3000</h1>
      <p class="record-label">Record</p>
      <div class="record-beat" ></div>
      <button class="play-button">Play</button>
      <div class=pad-subcontainer>
        <div padCode="81" class="pad">
          <p>Q</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="87" class="pad">
          <p>W</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="69" class="pad">
          <p>E</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
      </div>
      <div class=pad-subcontainer>
        <div padCode="65" class="pad">
          <p>A</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="83" class="pad">
          <p>S</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="68" class="pad">
          <p>D</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
      </div>
        <div class=pad-subcontainer>
        <div padCode="90" class="pad">
          <p>Z</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="88" class="pad">
          <p>X</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        <div padCode="67" class="pad">
          <p>C</p>
          <img class="red-button" src="./public/images/redbutton.png" alt="record-button">
        </div>
        </div>
    </div>

    <audio padCode="81" src="/public/audio/kick.wav"></audio>
    <audio padCode="87" src="/public/audio/snare.wav" ></audio>
    <audio padCode="69" src="/public/audio/hihat.wav"></audio>
    <audio padCode="65" src="/public/audio/MRLSHZ_vocal_group_ah_chord_harm_dry_Cm.wav"></audio>
    <audio padCode="83" src="/public/audio/MRLSHZ_vocal_group_ah_chord_harm_dry_Fm7.wav"></audio>
    <audio padCode="68" src="/public/audio/Reverse_Crash_1.wav"></audio>
    <audio padCode="90" src="/public/audio/PMBH_Crash_Clash.wav"></audio>
    <audio padCode="88" src="/public/audio/woo.wav"></audio>
    <audio padCode="67" src="/public/audio/hey.wav"></audio>

    <audio id="metronome" src="/public/audio/beep.wav"></audio>


    <script> //button blinks and metronome 
      recordButtons = document.querySelectorAll(".red-button")
      metronome = document.getElementById("metronome")

      for (const button of recordButtons) {
        button.addEventListener("click", ()=>{
         
          if(button.classList.contains("record-on")) {
            button.classList.remove("record-on")
            clearInterval(beep);
            metronome.pause();
          } else {
              button.classList.add("record-on")
              beep = setInterval(() => {
              metronome.volume = 1.0
              metronome.play();
            }, 700);
          }
          for (const newButton of recordButtons) {
            if(button !== newButton) {
              if(button.classList.contains("record-on")) {
                newButton.classList.add("not-recording")
              } else {
                newButton.classList.remove("not-recording")
              }
            }
          }
           setTimeout(() => {
            clearInterval(beep)
          }, 2800);
        })
      }
      
    </script>

    <script> 
     let startingTime;
     let beats = [];


     const playSong = ( () => {
       let audio;
       if (beats.length === 0) return;
       console.log(beats)
       beats.forEach(beat => {
         setTimeout(() => {
            audio = document.querySelector(`audio[padCode="${beat.note}"]`)
            audio.play(); 
         }, beat.clickedTime)
        })
      });
         
        //  const pad = document.querySelector(`.pad[padCode="${beat.note}"]`)
        //  pad.classList.add('pressed');
         
        //  setTimeout(function () {
        //   pad.classList.remove("pressed")
        //  }, 100)}
    
       
     playButton = document.querySelector(".play-button")
     recordBeat = document.querySelector(".record-beat");

     recordBeat.addEventListener("click", () => {
        recordBeat.classList.toggle("recording");

        if (recordBeat.classList.contains("recording")) {
          startingTime = Date.now();
          playButton.classList.add('hide');
          beats = [];
        } else {
          playButton.classList.remove('hide')
        }
      })

      playButton.addEventListener("click", playSong)

      buttons = document.querySelectorAll("p")
      for (const button of buttons) {
        button.addEventListener("click", playSound)
      }
      window.addEventListener('keydown', playSound);

      function playSound(e) {
        let event;
        if(e.keyCode) {
          event = e.keyCode 
        } else {
          event = e.path[1].attributes[0].nodeValue
        }
        const audio = document.querySelector(`audio[padCode="${event}"]`)
        if(!audio) return;
        if (recordBeat.classList.contains("recording")) {
           beats.push({note: event, clickedTime: (Date.now() - startingTime)});
        }
        audio.currentTime= 0;
        audio.play();
        const pad = document.querySelector(`.pad[padCode="${event}"]`)
        pad.classList.add('pressed');
        setTimeout(function() {
          pad.classList.remove("pressed")
        }, 100)
      };

      

    </script>

    <script>

      navigator.mediaDevices.getUserMedia({audio:true, video:false})
        .then(function (mediaStreamObj) {
          let recordButtons = document.querySelectorAll(".red-button"); 
          let mediaRecorder = new MediaRecorder(mediaStreamObj);
          let chunks = [];

         for (const button of recordButtons) {
           button.addEventListener('click', (e) => {
             padCode = e.path[1].attributes[0].nodeValue

             const audioPlayback = document.querySelector(`audio[padCode="${padCode}"]`) 
              if (!button.classList.contains("record-on")) {
                mediaRecorder.stop();
                console.log(mediaRecorder.state);
              } else {
                setTimeout(() => {
                mediaRecorder.start();
                console.log(mediaRecorder.state);
                }, 3500); 
              }
               mediaRecorder.ondataavailable = function (e) {
               chunks.push(e.data);
             }
               mediaRecorder.onstop = (e) => {
               let blob = new Blob(chunks, { 'type': 'audio/wav' });
               chunks = [];
               let audioURL = window.URL.createObjectURL(blob);
               audioPlayback.src = audioURL;
             }
           })
         }
        })
        .catch(function (err) {
          console.log(err.name, err.message);
        });
  </script>
  </body>
</html>